/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package com.examples.hello.pulsar;

import org.apache.pulsar.client.api.PulsarClient;
import org.apache.pulsar.client.api.PulsarClientException;
import org.apache.pulsar.client.impl.schema.AvroSchema;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.time.Instant;
import java.util.Optional;
import java.util.Random;

public class App {
    private static final Logger logger = LoggerFactory.getLogger(App.class);

    public static void main(String[] args) throws PulsarClientException, InterruptedException {
      var client = createClient(getProp("PULSAR_HOST", "localhost"));
      var topic = getProp("PULSAR_TOPIC", "conditions");
      var isProducer = Boolean.parseBoolean(getProp("PULSAR_PRODUCER", "false"));
      if (isProducer)
        produce(client, topic);
      else
        consume(client, topic);
      client.close();
    }

    public static void consume(PulsarClient client, String topic) throws PulsarClientException {
      var subscriptionName = getProp("PULSAR_SUBSCRIPTION_NAME", "my-java-sub");
      var consumer = client.newConsumer(AvroSchema.of(Condition.class))
        .topic(topic)
        .subscriptionName(subscriptionName)
        .subscribe();

      while (true) {
        var msg = consumer.receive();
        try {
          var condition = msg.getValue();
          var ts = Instant.ofEpochMilli(msg.getPublishTime());
          var id = msg.getMessageId();
          var t = condition.getTemperature();
          var h = condition.getHumidity();
          logger.info("Received msg(time={} id={}), condition(T={} H={})", ts, id, t, h);

          consumer.acknowledge(msg);
        } catch (Exception e) {
          logger.error("Could not receive message", e);
          consumer.negativeAcknowledge(msg);
        }
      }
    }

    public static void produce(PulsarClient client, String topic) throws PulsarClientException, InterruptedException {
      var producer = client.newProducer(AvroSchema.of(Condition.class))
        .topic(topic)
        .create();
      var condition = new Condition();
      var rnd = new Random();
      var sleepMs = Integer.parseInt(getProp("PULSAR_INTERVAL_MS", "0"));
      while (true) {
        var t = rnd.nextFloat() * 40;
        var h = rnd.nextFloat() * 100;
        condition.setTemperature(t);
        condition.setHumidity(h);
        producer.send(condition);
        logger.info("Sent condition(T={} H={})", t, h);
        if (sleepMs > 0)
          Thread.sleep(sleepMs);
      }
    }

    public static PulsarClient createClient(String pulsarHost) throws PulsarClientException {
      var serviceUrl = String.format("pulsar://%s:6650", pulsarHost);
      return PulsarClient.builder()
        .serviceUrl(serviceUrl)
        .build();
    }

    public static String getProp(String name, String defaultValue)
    {
      return Optional.ofNullable(System.getenv(name))
          .orElse(System.getProperty(name, defaultValue));
    }
}

